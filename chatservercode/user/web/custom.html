



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>
  <style>
    .chatbot-footer {
      position: relative;
    }

    .file-input-label {
      cursor: pointer;
    }

    .fa-solid {
      margin-right: 3px;
    }

    .fa-paperclip {
      font-size: 24px;
      margin-right: 7px;
      margin-top: 10px;
    }

    .fa-file {
      font-size: 50px;
      color: honeydew;
    }

    .file-name-display {
      color: #0d6efd; 
      /* #353e49; */
      /* font-weight: 700; */
      margin-left: 5px;
    }

    .attachment-popup {
      position: absolute;
      bottom: 55px;
      background-color: #fff;
      border: 1px solid #ccc;
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
      z-index: 999;
      border-radius: 10px;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }

    .file-name {
      padding-left: 6px;
      height: 10px;
      width: 30px;
      font-size: 13px;
    }

    .close-button {
      height: 10px;
      width: 30px;
      font-size: 7px;
    }

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown select {
      width: 200px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #fff;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
  <link rel="stylesheet" href="style.css" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
  />
</head>

<body>
  <div class="chatbot-container">
    <div class="chatbot-header d-flex">
      <img src="./images/zeniuslogo.png" alt="zenius" class="logo" />
      <h2 id="chatHeader">Chat with agent</h2>
    </div>
    <div class="chatcolor">
      <div class="chatbot-body" id="chatbot-body"></div>
      <div class="chatbot-footer">
        <input
          type="text"
          placeholder="Type your message here..."
          id="user-message"
        />
        <label for="file-input" class="file-input-label">
          <i class="fas fa-paperclip"></i>
        </label>
        <input type="file" id="file-input" multiple style="display: none" />
        <button onclick="startChat()">Send</button>
        <div id="attachment-popup" class="attachment-popup" style="display: none">
          <span class="file-name" id="attachment-name"></span>
          <i class="fa-solid fa-xmark" onclick="closePopup()"></i>
        </div>
      </div>
    </div>
  </div>

  <script>
    let typingTimeout;
    const typingDelay = 50;

    document
      .getElementById("user-message")
      .addEventListener("input", function () {
        let session_id = getParameterByName("session_id");
        socket.send(
          JSON.stringify({
            event: "typing",
            data: " typing.... ",
            session_id: session_id,
          })
        );

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          socket.send(
            JSON.stringify({
              event: "stop_typing",
              data: "user stopped typing",
              session_id: session_id,
            })
          );
        }, typingDelay);
      });

    document
      .getElementById("file-input")
      .addEventListener("change", function () {
        const files = this.files;
        if (files.length > 0) {
          let fileNames = Array.from(files).map(file => file.name).join(', ');
          showPopup(fileNames);
        }
      });

    function showPopup(fileNames) {
      var attachmentName = document.getElementById("attachment-name");
      attachmentName.textContent = fileNames;
      document.getElementById("attachment-popup").style.display = "block";
    }

    function closePopup() {
      document.getElementById("attachment-popup").style.display = "none";
    }

    window.onload = function () {
      setTimeout(function () {
        const chatbotBody = document.getElementById("chatbot-body");
        const initialMessage = "chat with agent..";
        chatbotBody.innerHTML +=
          '<div class="first-chat-message"><p>' +
          initialMessage +
          "</p></div>";
        chatbotBody.scrollTop = chatbotBody.scrollHeight;
      }, 1000);
    };

    const socket = new WebSocket("ws://127.0.0.1:9000/ws/agent");

    socket.addEventListener("message", function (event) {
      
      var data = JSON.parse(event.data);
      console.log("received message:", data);
      var chatbotBody = document.getElementById("chatbot-body");
      var messageContent = '';
        // If the received message has files, loop through and display each
  if (data.hasOwnProperty("files") && data.files.length > 0) {
    data.files.forEach(file => {
      var fileLink = `<a href="${file.data}" download="${file.name}" type="${file.type}">${file.name}</a>`;
      messageContent += fileLink+' ';
    });
    messageContent += '<br>';
  }

  // If the received message contains text, display it
  if (data.hasOwnProperty("message")) {
    var messageText = data.message;
    if (messageText.startsWith("http")) {
      messageText = `<a href="${messageText}" target="_blank">${messageText}</a>`;
    }
    messageContent += messageText;
  }

  // If there's content to display, add it to the chat
  if (messageContent.trim() !== '') {
    const timestamp = formatTimestamp();
    var agentName = data.agentName || 'agent';
    chatbotBody.innerHTML +=
      `<div class="usermessage"><p class="timestampuser">${agentName} • ${timestamp}</p> <p class="chat-message">${messageContent}</p> </div>`;
    chatbotBody.scrollTop = chatbotBody.scrollHeight;
  }
});

    socket.onerror = function (event) {
      console.error("WebSocket error:", event);
    };

    document
      .getElementById("user-message")
      .addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          startChat();
        }
      });

      function startChat() {
  const userInput = document.getElementById("user-message").value.trim();
  const chatbotBody = document.getElementById("chatbot-body");
  const fileInput = document.getElementById("file-input");
  const files = fileInput.files;

  if (userInput !== "" || files.length > 0) {
    const timestamp = formatTimestamp();
    const name = getParameterByName("firstname");
    const metadata = {
      session_id: getParameterByName("session_id"),
    };

    const message = {
      metadata: metadata,
      name: name,
      phone: getParameterByName("phone"),
      userInput: userInput,
      queues: getParameterByName("queues"),
      skills: getParameterByName("skills"),
      timestamp: new Date().toISOString(),
      email: getParameterByName("email"),
      emailtranscript: getParameterByName("emailtranscript"),
      files: []  // Initialize an array to hold file data
    };

    let filesRead = 0;  // Counter for files read
    let allFileAnchors = "";

    if (files.length > 0) {
      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function (event) {
          const fileData = event.target.result;
  console.log("file data is",fileData)
          // Push file data to the message object
          message.files.push({
            name: file.name,
            type: file.type,
            data: fileData,
          });

          const anchorTag = `<a href="${fileData}" download="${file.name}" class="file-name-display">${file.name}</a>`;
          allFileAnchors += anchorTag + " "; 
          filesRead++;  
         
         if (filesRead === files.length) {

          // Update the UI for each file
          const fileHtml =
            `<div><p class="timestamp">${name} • ${formatTimestamp()}</p>` +
            `<p class="user-message">` +
              allFileAnchors+`<br>${userInput}</p></div>`;
                        
           // `<a href="${fileData}" download="${file.name}" class="file-name-display">${file.name}</a><br>${userInput}</p></div>`;
          
          chatbotBody.innerHTML += fileHtml;
          chatbotBody.scrollTop = chatbotBody.scrollHeight;
          console.log("files in message",message)
          // filesRead++;  
         
          // if (filesRead === files.length) {
            // Send message through socket after all files are read
            socket.send(JSON.stringify(message));
            fileInput.value = "";  // Clear file input
            document.getElementById("user-message").value = "";  // Clear user message input
            closePopup();  // Close the popup
          }
        };
        reader.readAsDataURL(file);
      });
    } else {
      chatbotBody.innerHTML +=
        `<div><p class="timestamp">${name} • ${timestamp}</p> <p class="user-message">${userInput}</p></div>`;
      chatbotBody.scrollTop = chatbotBody.scrollHeight;

      // Send message through socket
      socket.send(JSON.stringify(message));
      document.getElementById("user-message").value = "";
    }
  }
}
 
    function formatTimestamp() {
      const now = new Date();
      return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function getParameterByName(name) {
      const url = window.location.href;
      const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

     // Function to fetch messages from API
     function fetchMessages() {
          console.log("printing inside fetch messages one time");
          return fetch("http://10.16.7.113:8080/api/chat_hold_messages/")
            .then((response) => response.json())
            .then((data) => {
              messages = data; // Store fetched messages
              console.log("Messages fetched:", messages);
            })
            .catch((error) => {
              console.error("Error fetching messages:", error);
            });
        }
  </script>
</body>
</html>












<!-- 
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>
  <style>
    .chatbot-footer {
      position: relative;
    }

    .file-input-label {
      cursor: pointer;
    }

    .fa-solid {
      margin-right: 3px;
    }

    .fa-paperclip {
      font-size: 24px;
      margin-right: 7px;
      margin-top: 10px;
    }

    .fa-file {
      font-size: 50px;
      color: honeydew;
    }

    .file-name-display {
      color: #353e49;
      font-weight: 700;
      margin-left: 5px;
    }

    .attachment-popup {
      position: absolute;
      bottom: 55px;
      background-color: #fff;
      border: 1px solid #ccc;
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
      z-index: 999;
      border-radius: 10px;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }

    .file-name {
      padding-left: 6px;
      height: 10px;
      width: 30px;
      font-size: 13px;
    }

    .close-button {
      height: 10px;
      width: 30px;
      font-size: 7px;
    }

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown select {
      width: 200px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #fff;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
  <link rel="stylesheet" href="style.css" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
  />
</head>

<body>
  <div class="chatbot-container">
    <div class="chatbot-header d-flex">
      <img src="./images/zeniuslogo.png" alt="zenius" class="logo" />
      <h2 id="chatHeader">Chat with agent</h2>
    </div>
    <div class="chatcolor">
      <div class="chatbot-body" id="chatbot-body"></div>
      <div class="chatbot-footer">
        <input
          type="text"
          placeholder="Type your message here..."
          id="user-message"
        />
        <label for="file-input" class="file-input-label">
          <i class="fas fa-paperclip"></i>
        </label>
        <input type="file" id="file-input" multiple style="display: none" />
        <button onclick="startChat()">Send</button>
        <div id="attachment-popup" class="attachment-popup" style="display: none">
          <span class="file-name" id="attachment-name"></span>
          <i class="fa-solid fa-xmark" onclick="closePopup()"></i>
        </div>
      </div>
    </div>
  </div>

  <script>
    let typingTimeout;
    const typingDelay = 50;

    document
      .getElementById("user-message")
      .addEventListener("input", function () {
        let session_id = getParameterByName("session_id");
        socket.send(
          JSON.stringify({
            event: "typing",
            data: " typing.... ",
            session_id: session_id,
          })
        );

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          socket.send(
            JSON.stringify({
              event: "stop_typing",
              data: "user stopped typing",
              session_id: session_id,
            })
          );
        }, typingDelay);
      });

    document
      .getElementById("file-input")
      .addEventListener("change", function () {
        const files = this.files;
        if (files.length > 0) {
          let fileNames = Array.from(files).map(file => file.name).join(', ');
          showPopup(fileNames);
        }
      });

    function showPopup(fileNames) {
      var attachmentName = document.getElementById("attachment-name");
      attachmentName.textContent = fileNames;
      document.getElementById("attachment-popup").style.display = "block";
    }

    function closePopup() {
      document.getElementById("attachment-popup").style.display = "none";
    }

    window.onload = function () {
      setTimeout(function () {
        const chatbotBody = document.getElementById("chatbot-body");
        const initialMessage = "chat with agent..";
        chatbotBody.innerHTML +=
          '<div class="first-chat-message"><p>' +
          initialMessage +
          "</p></div>";
        chatbotBody.scrollTop = chatbotBody.scrollHeight;
      }, 1000);
    };

    const socket = new WebSocket("ws://127.0.0.1:9000/ws/agent");

    socket.addEventListener("message", function (event) {
      var data = JSON.parse(event.data);
      console.log("received message:", data);
      var chatbotBody = document.getElementById("chatbot-body");
      var messageContent = '';

      if (data.hasOwnProperty("file") && data.file && data.file.data) {
        var fileLink = `<a href="${data.file.data}" download="${data.file.name}" type="${data.file.type}">${data.file.name}</a>`;
        messageContent += fileLink + '<br>';
      }

      if (data.hasOwnProperty("message")) {
        var messageText = data.message;
        if (messageText.startsWith("http")) {
          messageText = `<a href="${messageText}" target="_blank">${messageText}</a>`;
        }
        messageContent += messageText;
      }

      if (messageContent.trim() !== '') {
        const timestamp = formatTimestamp();
        var agentName = data.agentName || 'agent';
        chatbotBody.innerHTML +=
          `<div class="usermessage"><p class="timestampuser">${agentName} • ${timestamp}</p> <p class="chat-message">${messageContent}</p> </div>`;
        chatbotBody.scrollTop = chatbotBody.scrollHeight;
      }
    });

    socket.onerror = function (event) {
      console.error("WebSocket error:", event);
    };

    document
      .getElementById("user-message")
      .addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          startChat();
        }
      });

    function startChat() {
      const userInput = document.getElementById("user-message").value.trim();
      const chatbotBody = document.getElementById("chatbot-body");
      const fileInput = document.getElementById("file-input");
      const files = fileInput.files;

      if (userInput !== "" && files.length === 0) {
        const timestamp = formatTimestamp();
        const name = getParameterByName("firstname");
        chatbotBody.innerHTML +=
          `<div><p class="timestamp">${name} • ${timestamp}</p> <p class="user-message">${userInput}</p></div>`;
        chatbotBody.scrollTop = chatbotBody.scrollHeight;
      }

      if (files.length > 0) {
        Array.from(files).forEach(file => {
          const reader = new FileReader();
          reader.onload = function (event) {
            const fileData = event.target.result;
            const metadata = {
              session_id: getParameterByName("session_id"),
            };

            const message = {
              metadata: metadata,
              name: getParameterByName("firstname"),
              phone: getParameterByName("phone"),
              userInput: userInput,
              queues: getParameterByName("queues"),
              skills: getParameterByName("skills"),
              timestamp: new Date().toISOString(),
              email: getParameterByName("email"),
              emailtranscript: getParameterByName("emailtranscript"),
              file: {
                name: file.name,
                type: file.type,
                data: fileData,
              },
            };

            const fileHtml =
              `<div><p class="timestamp">${getParameterByName("firstname")} • ${formatTimestamp()}</p>` +
              `<p class="user-message"><i class="fas fa-file"></i> ` +
              `<a href="${fileData}" download="${file.name}" class="file-name-display">${file.name}</a><br>${userInput}</p></div>`;

            chatbotBody.innerHTML += fileHtml;
            chatbotBody.scrollTop = chatbotBody.scrollHeight;
            socket.send(JSON.stringify(message));
          };
          reader.readAsDataURL(file);
        });
        fileInput.value = "";
        closePopup();
      } else {
        const metadata = {
          session_id: getParameterByName("session_id"),
        };

        const message = {
          metadata: metadata,
          name: getParameterByName("firstname"),
          phone: getParameterByName("phone"),
          userInput: userInput,
          queues: getParameterByName("queues"),
          skills: getParameterByName("skills"),
          timestamp: new Date().toISOString(),
          email: getParameterByName("email"),
          emailtranscript: getParameterByName("emailtranscript"),
        };

        chatbotBody.innerHTML +=
          `<div><p class="timestamp">${getParameterByName("firstname")} • ${formatTimestamp()}</p> <p class="user-message">${userInput}</p></div>`;
        chatbotBody.scrollTop = chatbotBody.scrollHeight;
        socket.send(JSON.stringify(message));
      }

      document.getElementById("user-message").value = "";
    }

    function formatTimestamp() {
      const now = new Date();
      return now.toLocaleString();
    }

    function getParameterByName(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }
  </script>
</body>
</html>
 -->
























<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>
  <style>
    .chatbot-footer {
      position: relative;
    }

    .file-input-label {
      cursor: pointer;
    }

    .fa-solid {
      margin-right: 3px;
    }

    .fa-paperclip {
      font-size: 24px;
      margin-right: 7px;
      margin-top: 10px;
    }

    .fa-file {
      font-size: 50px;
      color: honeydew;
    }

    .file-name-display {
      color: #353e49;
      font-weight: 700;
      margin-left: 5px;
    }

    .attachment-popup {
      position: absolute;
      bottom: 55px;
      background-color: #fff;
      border: 1px solid #ccc;
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
      z-index: 999;
      border-radius: 10px;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }

    .file-name {
      padding-left: 6px;
      height: 10px;
      width: 30px;
      font-size: 13px;
    }

    .close-button {
      height: 10px;
      width: 30px;
      font-size: 7px;
    }

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown select {
      width: 200px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #fff;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
  <link rel="stylesheet" href="style.css" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
  />
</head>

<body>
  <div class="chatbot-container">
    <div class="chatbot-header d-flex">
      <img src="./images/zeniuslogo.png" alt="zenius" class="logo" />
      <h2 id="chatHeader">Chat with agent</h2>
    </div>
    <div class="chatcolor">
      <div class="chatbot-body" id="chatbot-body"></div>
      <div class="chatbot-footer">
        <input
          type="text"
          placeholder="Type your message here..."
          id="user-message"
        />
        <label for="file-input" class="file-input-label">
          <i class="fas fa-paperclip"></i>
        </label>
        <input type="file" id="file-input" style="display: none" />
        <button onclick="startChat()">Send</button>
        <div id="attachment-popup" class="attachment-popup" style="display: none">
          <span class="file-name" id="attachment-name"></span>
          <i class="fa-solid fa-xmark" onclick="closePopup()"></i>
        </div>
      </div>
    </div>
  </div>

  <script>
    let typingTimeout;
    const typingDelay = 50;

    document
      .getElementById("user-message")
      .addEventListener("input", function () {
        let session_id = getParameterByName("session_id");
        socket.send(
          JSON.stringify({
            event: "typing",
            data: " typing.... ",
            session_id: session_id,
          })
        );

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          socket.send(
            JSON.stringify({
              event: "stop_typing",
              data: "user stopped typing",
              session_id: session_id,
            })
          );
        }, typingDelay);
      });

    document
      .getElementById("file-input")
      .addEventListener("change", function () {
        var file = this.files[0];
        if (file) {
          showPopup(file.name);
        }
      });

    function showPopup(fileName) {
      var attachmentName = document.getElementById("attachment-name");
      attachmentName.textContent = fileName;
      document.getElementById("attachment-popup").style.display = "block";
    }

    function closePopup() {
      document.getElementById("attachment-popup").style.display = "none";
    }

    window.onload = function () {
      setTimeout(function () {
        const chatbotBody = document.getElementById("chatbot-body");
        const initialMessage = "chat with agent..";
        chatbotBody.innerHTML +=
          '<div class="first-chat-message"><p>' +
          initialMessage +
          "</p></div>";
        chatbotBody.scrollTop = chatbotBody.scrollHeight;
      }, 1000);
    };

    const socket = new WebSocket("ws://127.0.0.1:9000/ws/agent");

    socket.addEventListener("message", function (event) {
      var data = JSON.parse(event.data);
      console.log("received message:", data);
      var chatbotBody = document.getElementById("chatbot-body");
      var messageContent = '';

      if (data.hasOwnProperty("file") && data.file && data.file.data) {
        var fileLink = `<a href="${data.file.data}" download="${data.file.name}" type="${data.file.type}">${data.file.name}</a>`;
        messageContent += fileLink + '<br>';
      }

      if (data.hasOwnProperty("message")) {
        var messageText = data.message;
        if (messageText.startsWith("http")) {
          messageText = `<a href="${messageText}" target="_blank">${messageText}</a>`;
        }
        messageContent += messageText;
      }

      if (messageContent.trim() !== '') {
        const timestamp = formatTimestamp();
        var agentName = data.agentName || 'agent';
        chatbotBody.innerHTML +=
          `<div class="usermessage"><p class="timestampuser">${agentName} • ${timestamp}</p> <p class="chat-message">${messageContent}</p> </div>`;
        chatbotBody.scrollTop = chatbotBody.scrollHeight;
      }
    });

    socket.onerror = function (event) {
      console.error("WebSocket error:", event);
    };

    document
      .getElementById("user-message")
      .addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          startChat();
        }
      });

    function startChat() {
      const userInput = document.getElementById("user-message").value.trim();
      const chatbotBody = document.getElementById("chatbot-body");
      const fileInput = document.getElementById("file-input");
      const file = fileInput.files[0];

      if (userInput !== "" && file == null) {
        const timestamp = formatTimestamp();
        const name = getParameterByName("firstname");
        chatbotBody.innerHTML +=
          `<div><p class="timestamp">${name} • ${timestamp}</p> <p class="user-message">${userInput}</p></div>`;
        chatbotBody.scrollTop = chatbotBody.scrollHeight;
      }

      if (file) {
        const reader = new FileReader();
        reader.onload = function (event) {
          const fileData = event.target.result;
          const metadata = {
            session_id: getParameterByName("session_id"),
          };

          const message = {
            metadata: metadata,
            name: getParameterByName("firstname"),
            phone: getParameterByName("phone"),
            userInput: userInput,
            queues: getParameterByName("queues"),
            skills: getParameterByName("skills"),
            timestamp: new Date().toISOString(),
            email: getParameterByName("email"),
            emailtranscript: getParameterByName("emailtranscript"),
            file: {
              name: file.name,
              type: file.type,
              data: fileData,
            },
          };

          const fileHtml =
            `<div><p class="timestamp">${name} • ${formatTimestamp()}</p>` +
            `<p class="user-message"><i class="fas fa-file"></i> ` +
            `<a href="${fileData}" download="${file.name}" class="file-name-display">${file.name}</a><br>${userInput}</p></div>`;

          chatbotBody.innerHTML += fileHtml;
          chatbotBody.scrollTop = chatbotBody.scrollHeight;
          socket.send(JSON.stringify(message));
          fileInput.value = "";
          closePopup();
        };
        reader.readAsDataURL(file);
      } else {
        const metadata = {
          session_id: getParameterByName("session_id"),
        };

        const message = {
          metadata: metadata,
          name: getParameterByName("firstname"),
          phone: getParameterByName("phone"),
          userInput: userInput,
          queues: getParameterByName("queues"),
          skills: getParameterByName("skills"),
          timestamp: new Date().toISOString(),
          email: getParameterByName("email"),
          emailtranscript: getParameterByName("emailtranscript"),
        };

        socket.send(JSON.stringify(message));
      }

      document.getElementById("user-message").value = "";
    }

    function getParameterByName(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    function formatTimestamp() {
      const now = new Date();
      const options = {
        hour: "numeric",
        minute: "numeric",
        hour12: true,
      };
      return now.toLocaleString("en-US", options);
    }
  </script>
</body>
</html>
 -->











<!-- <!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <style>
      .chatbot-footer {
        position: relative;
      }

      .file-input-label {
        cursor: pointer;
      }

      .fa-solid {
        margin-right: 3px;
      }

      .fa-paperclip {
        font-size: 24px;
        margin-right: 7px;
        margin-top: 10px;
      }
      .fa-file {
        font-size: 50px;
        color: honeydew;
      }

      .file-name-display {
        color: #353e49; /* Example color */
        font-weight: 700; /* Example font weight */
        margin-left: 5px; /* Space between icon and file name */
      }

      .attachment-popup {
        position: absolute;
        bottom: 55px;
        background-color: #fff;
        border: 1px solid #ccc;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
        z-index: 999;
        border-radius: 10px;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }

      .file-name {
        padding-left: 6px;
        height: 10px;
        width: 30px;
        font-size: 13px;
        /* background-color: #ccc; */
        border-radius: 5px;
      }

      .close-button {
        height: 10px;
        width: 30px;
        font-size: 7px;
        /* Add styles for close button */
      }

      /* Dropdown Styles */
      .dropdown {
        position: relative;
        display: inline-block;
      }

      /* Dropdown Button */
      .dropdown select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        width: 200px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #fff;
        font-size: 16px;
        cursor: pointer;
        outline: none;
      }

      /* Dropdown Arrow Icon */
      .dropdown::after {
        content: "\25BC";
        position: absolute;
        top: 50%;
        right: 15px;
        transform: translateY(-50%);
        pointer-events: none;
      }

      /* Dropdown Hover State */
      .dropdown:hover select {
        border-color: #aaa;
      }

      /* Dropdown Focus State */
      .dropdown select:focus {
        border-color: #555;
      }
    </style>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.min.js"></script>
    <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
      integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>

  <body>
    <div class="chatbot-container">
      <div class="chatbot-header d-flex">
        <img src="./images/zeniuslogo.png" alt="zenius" class="logo" />
        <h2 id="chatHeader">Chat with agent</h2>
      </div>
      <div class="chatcolor">
        <div class="chatbot-body" id="chatbot-body"></div>
        <div class="chatbot-footer">
          <input
            type="text"
            placeholder="Type your message here..."
            id="user-message"
          />
          <label for="file-input" class="file-input-label">
            <i class="fas fa-paperclip"></i>
          </label>
          <input type="file" id="file-input" style="display: none" />
          <button onclick="startChat()">Send</button>
          <div
            id="attachment-popup"
            class="attachment-popup"
            style="display: none"
          >
            <span class="file-name" id="attachment-name"></span>
            <i class="fa-solid fa-xmark" onclick="closePopup()"></i>
          </div>
        </div>
      </div>
    </div>

    <script>
      // New code: Adding typing event listener
      let typingTimeout;
      const typingDelay = 50; // 0.5 seconds

      let startTime = null;
      let elapsedTime = 0;
      let intervalId = null;

      document
        .getElementById("user-message")
        .addEventListener("input", function () {
          let session_id = getParameterByName("session_id");
          socket.send(
            JSON.stringify({
              event: "typing",
              data: " typing.... ",
              session_id: session_id,
            })
          );

          clearTimeout(typingTimeout);
          typingTimeout = setTimeout(() => {
            session_id = getParameterByName("session_id");
            socket.send(
              JSON.stringify({
                event: "stop_typing",
                data: "user stopped typing",
                session_id: session_id,
              })
            );
          }, typingDelay);
        });
      // End of new code

      document
        .getElementById("file-input")
        .addEventListener("change", function () {
          var file = this.files[0];
          if (file) {
            showPopup(file.name);
          }
        });

      function showPopup(fileName) {
        var attachmentName = document.getElementById("attachment-name");
        attachmentName.textContent = fileName;
        var popup = document.getElementById("attachment-popup");
        popup.style.display = "block";
      }

      function closePopup() {
        document.getElementById("attachment-popup").style.display = "none";
      }

      function dropdownChanged() {
        var selectedValue = document.getElementById("statusDropdown").value;
        console.log("current state: ", selectedValue);
        ws.send(selectedValue);
      }

      window.onload = function () {
        setTimeout(function () {
          const chatbotBody = document.getElementById("chatbot-body");
          const initialMessage = "chat with agent..";
          chatbotBody.innerHTML +=
            '<div class="first-chat-message"><p>' +
            initialMessage +
            "</p></div>";
          chatbotBody.scrollTop = chatbotBody.scrollHeight;
        }, 1000); // Execute after 1 second
      };

      const socket = new WebSocket("ws://127.0.0.1:9000/ws/agent");
      //const socket = new WebSocket('ws://10.16.7.113:8000/ws/agent');

      socket.addEventListener("message", function (event) {
        console.log("Message from server:", event.data);
      });

      let agentNameMessageAdded = false;
      var typingMessageElement = null;


      socket.onmessage = function (event) {
  var data = JSON.parse(event.data);
  console.log("received message:", data);
  
  var chatbotBody = document.getElementById("chatbot-body");
  var usersession_id = getParameterByName("session_id");

  // Create message content variable to store the final content
  var messageContent = '';

  // Handle file
  if (data.hasOwnProperty("file") && data.file && data.file.data) {
    var file = data.file.data;
    var fileType = data.file.type || "application/octet-stream";
    var fileName = data.file.name || "downloaded_file";
    var fileLink = `<a href="${file}" download="${fileName}" type="${fileType}">${fileName}</a>`;
    messageContent += fileLink + '<br>';  // Add file link if present
  }

  // Handle message
  if (data.hasOwnProperty("message")) {
    var messageText = data.message;
    if (messageText.startsWith("http")) {
      messageText = `<a href="${messageText}" target="_blank">${messageText}</a>`;
    }
    messageContent += messageText;  // Add message text if present
  }

  // Only append the message if there's content
  if (messageContent.trim() !== '') {
    const timestamp = formatTimestamp();
    var agentName = data.agentName || 'agent';  // Default to 'agent' if agentName not present

    chatbotBody.innerHTML +=
      `<div class="usermessage"><p class="timestampuser">${agentName} • ${timestamp}</p> <p class="chat-message">${messageContent}</p> </div>`;
    
    chatbotBody.scrollTop = chatbotBody.scrollHeight;  // Scroll to bottom
  }
};

//       socket.onmessage = function (event) {
//   var data = JSON.parse(event.data);
//   console.log("received message:", data);

//   var chatbotBody = document.getElementById("chatbot-body");
//   var agentName = data.agentName || 'agent';
//   const timestamp = formatTimestamp();

//   // Create a container for the message
//   var messageContainer = document.createElement("div");
//   messageContainer.className = "usermessage";

//   // Create a string to hold the content
//   var messageContent = '';

//   // Handle file
//   if (data.hasOwnProperty("file") && data.file && data.file.data) {
//     var file = data.file.data;
//     var fileType = data.file.type || "application/octet-stream"; // default to binary file if type is not provided
//     var fileName = data.file.name || "downloaded_file"; // default file name

//     // Create a downloadable link for the file
//     var fileLink = `<a href="${file}" download="${fileName}" type="${fileType}"> ${fileName}</a>`;
//     messageContent += fileLink + '<br>';  // Add the file link to the content
//   }

//   // Handle message
//   if (data.hasOwnProperty("message")) {
//     var messageText = data.message;
//     if (messageText.startsWith("http")) {
//       messageText = `<a href="${messageText}" target="_blank">${messageText}</a>`;
//     }
//     messageContent += messageText;  // Add the message to the content
//   }

//   // Insert both file and message into the same message bubble
//   messageContainer.innerHTML = `
//     <p class="timestampuser">${agentName} • ${timestamp}</p>
//     <p class="chat-message">${messageContent}</p>
//   `;
  
//   chatbotBody.appendChild(messageContainer);
//   chatbotBody.scrollTop = chatbotBody.scrollHeight;
// };


//       socket.onmessage = function (event) {
//   var data = JSON.parse(event.data);
//   console.log("received message:", data);
//   console.log("received message for data.data:", data.data);

//   var chatbotBody = document.getElementById("chatbot-body");
//   var usersession_id = getParameterByName("session_id");

//   // Handle typing event
//   if (data.event === "typing" && data.session_id === usersession_id) {
//     if (!typingMessageElement) {
//       typingMessageElement = document.createElement("div");
//       typingMessageElement.className = "usermessage";
//       typingMessageElement.innerHTML = '<p class="chat-message">' + data.data + "</p>";

//       chatbotBody.appendChild(typingMessageElement);
//       chatbotBody.scrollTop = chatbotBody.scrollHeight;
//     }
//   } else if (data.event === "stop_typing") {
//     if (typingMessageElement) {
//       chatbotBody.removeChild(typingMessageElement);
//       typingMessageElement = null;
//     }
//   }

//   // Handle file
//   if (data.hasOwnProperty("file") && data.file && data.file.data) {
//     console.log("file is");
//     var file = data.file.data;
//     var fileType = data.file.type || "application/octet-stream"; // default to binary file if type is not provided
//     var fileName = data.file.name || "downloaded_file"; // default file name

//     // Create a downloadable link for the file
//     var fileLink = `<a href="${file}" download="${fileName}" type="${fileType}"> ${fileName}</a>`;

//     chatbotBody.innerHTML +=
//       '<div class="chat-message"><p>' + fileLink + "</p></div>";
//     chatbotBody.scrollTop = chatbotBody.scrollHeight;
//   }

//   // Handle message after file
//   if (data.hasOwnProperty("message")) {
//     var status = data.message;
//     console.log("Message:", status, data.agentName);
//     var agentName = data.agentName;
//     const timestamp = formatTimestamp();

//     if (agentName) {
//       document.getElementById("chatHeader").textContent = `Agent is live`;
//     }

//     if (!agentNameMessageAdded) {
//       chatbotBody.innerHTML +=
//         '<div class="usermessage"><p class="timestampuser">' +
//         agentName +
//         " • " +
//         timestamp +
//         '</p> <p class="chat-message">' +
//         `Chat with ${agentName} ...` +
//         " </p> </div>";
//       agentNameMessageAdded = true;
//     }

//     if (status.startsWith("http")) {
//       status = `<a href="${status}" target="_blank">${status}</a>`;
//     }

//     chatbotBody.innerHTML +=
//       '<div class="usermessage"><p class="timestampuser">' +
//       agentName +
//       " • " +
//       timestamp +
//       '</p> <p class="chat-message">' +
//       status +
//       " </p> </div>";
//     chatbotBody.scrollTop = chatbotBody.scrollHeight;
//   }
// };


//       socket.onmessage = function (event) {
//         var data = JSON.parse(event.data);
//         console.log("received message:", data);
//         console.log("received message for data.data:",data.data);
        

//         var chatbotBody = document.getElementById("chatbot-body");
//         var usersession_id = getParameterByName("session_id");
//         if (data.event === "typing" && data.session_id === usersession_id) {
//           if (!typingMessageElement) {
//             typingMessageElement = document.createElement("div");
//             typingMessageElement.className = "usermessage";
//             typingMessageElement.innerHTML =
//               '<p class="chat-message">' + data.data+ "</p>";
            
//             chatbotBody.appendChild(typingMessageElement);
//             chatbotBody.scrollTop = chatbotBody.scrollHeight;
//           }
//         } else if (data.event === "stop_typing") {
//           if (typingMessageElement) {
//             chatbotBody.removeChild(typingMessageElement);
//             typingMessageElement = null;
//           }
//         }

//         var chatbotBody = document.getElementById("chatbot-body");

//         if (data.hasOwnProperty("name")) {
//           status = data.name;
//           console.log("1111", status);
//         } 

//       else if (data.hasOwnProperty("file") && data.file && data.file.data) {
//         console.log("file is")
//   var file = data.file.data;
//   var fileType = data.file.type || 'application/octet-stream'; // default to binary file if type is not provided
//   var fileName = data.file.name || 'downloaded_file'; // default file name
 
//   // Create a downloadable link for the file
//   var fileLink = `<a href="${file}" download="${fileName}" type="${fileType}"> ${fileName}</a>`;
 
//   chatbotBody.innerHTML +=
//     '<div class="chat-message"><p>' + fileLink + "</p></div>";
//   chatbotBody.scrollTop = chatbotBody.scrollHeight;
// }
//         else if (data.hasOwnProperty("message_text")) {
//           status = data.message_text;
//           console.log("2222", status);
//           chatbotBody.innerHTML +=
//             '<div class="chat-message"><p>' + status + "</p></div>";
//           chatbotBody.scrollTop = chatbotBody.scrollHeight;
//         } else if (data.hasOwnProperty("message")) {
//           status = data.message;
//           console.log("3333", status, data.agentName);
//           agentName = data.agentName;
//           if (agentName) {
//             document.getElementById("chatHeader").textContent = `agent is live`;
//           }
//           const timestamp = formatTimestamp();

//           if (!agentNameMessageAdded) {
//             chatbotBody.innerHTML +=
//               '<div class="usermessage"><p class="timestampuser">' +
//               agentName +
//               " • " +
//               timestamp +
//               '</p> <p class="chat-message">' +
//               `chat with ${agentName} ...` +
//               " </p> </div>";
//             agentNameMessageAdded = true;
//           }

//           if (status.startsWith("http")) {
//             status = `<a href="${status}" target="_blank">${status}</a>`;

//             chatbotBody.innerHTML +=
//               '<div class="usermessage"><p class="timestampuser">' +
//               agentName +
//               " • " +
//               timestamp +
//               '</p> <p class="chat-message">' +
//               status +
//               " </p> </div>";
//             chatbotBody.scrollTop = chatbotBody.scrollHeight;
//           } else {
//             chatbotBody.innerHTML +=
//               '<div class="usermessage"><p class="timestampuser">' +
//               agentName +
//               " • " +
//               timestamp +
//               '</p> <p class="chat-message">' +
//               status +
//               " </p> </div>";
//             chatbotBody.scrollTop = chatbotBody.scrollHeight;
//           }

//         }
//       };

      socket.onerror = function (event) {
        console.error("WebSocket error:", event);
      };

      document
        .getElementById("user-message")
        .addEventListener("keypress", function (event) {
          if (event.key === "Enter") {
            event.preventDefault();
            startChat();
          }
        });
        

        

      function startChat() {
        const userInput = document.getElementById("user-message").value.trim();
        const chatbotBody = document.getElementById("chatbot-body");
        const fileInput = document.getElementById("file-input");
        const file = fileInput.files[0];
        console.log("file is",file)

        if (userInput !== "" && file==null) {
          console.log("userinput")
          const timestamp = formatTimestamp();
          name = getParameterByName("firstname");
          chatbotBody.innerHTML +=
            '<div><p class="timestamp">' +
            name +
            " • " +
            timestamp +
            '</p> <p class="user-message">' +
            userInput +
            " </p> </div>";
          chatbotBody.scrollTop = chatbotBody.scrollHeight;
        }

        if (file) {
          console.log("userinput if")
          const reader = new FileReader();
          reader.onload = function (event) {
            const fileData = event.target.result;

            const metadata = {
              session_id: getParameterByName("session_id"),
            };

            const message = {
              metadata: metadata,
              name: getParameterByName("firstname"),
              phone: getParameterByName("phone"),
              userInput: userInput,

              queues: getParameterByName("queues"),
              skills: getParameterByName("skills"),

              timestamp: new Date().toISOString(),
              email: getParameterByName("email"),
              emailtranscript: getParameterByName("emailtranscript"),
              file: {
                name: file.name,
                type: file.type,
                data: fileData,
              },
            };
            console.log("message ==>", message);

            // Display the file on the UI with a download link
            const fileHtml =
              '<div><p class="timestamp">' +
              name +
              " • " +
              formatTimestamp() +
              "</p>" +
              '<p class="user-message"><i class="fas fa-file"></i> ' +
              '<a href="' +
              fileData +
              '" download="' +
              file.name +
              '" class="file-name-display">' +
              file.name +
              "</a><br>" + // Line break to place userInput on the next line
  userInput +
  "</p></div>";

            chatbotBody.innerHTML += fileHtml;
            chatbotBody.scrollTop = chatbotBody.scrollHeight;
            console.log("json data before sending",JSON.stringify(message))

            // Send message to the server via WebSocket
            socket.send(JSON.stringify(message));

            // Clear file input
            fileInput.value = "";
            closePopup();
          };
          reader.readAsDataURL(file);
        } else {
          console.log("userinput else")
          const metadata = {
            session_id: getParameterByName("session_id"),
          };

          const message = {
            metadata: metadata,
            name: getParameterByName("firstname"),
            phone: getParameterByName("phone"),
            userInput: userInput,

            queues: getParameterByName("queues"),
            skills: getParameterByName("skills"),

            timestamp: new Date().toISOString(),
            email: getParameterByName("email"),
            emailtranscript: getParameterByName("emailtranscript"),
          };

          console.log("message :", message);

          // Send message to the server via WebSocket
          socket.send(JSON.stringify(message));
        }

        document.getElementById("user-message").value = "";
        document.getElementById("file-input").value = "";

        console.log("printing one time");

        startTime = new Date();
        if (intervalId) {
          clearInterval(intervalId); // Clear the previous interval if it exists
        }

        let messages = []; // Array to store fetched messages

        // Function to fetch messages from API
        function fetchMessages() {
          console.log("printing inside fetch messages one time");
          return fetch("http://10.16.7.113:8080/api/chat_hold_messages/")
            .then((response) => response.json())
            .then((data) => {
              messages = data; // Store fetched messages
              console.log("Messages fetched:", messages);
            })
            .catch((error) => {
              console.error("Error fetching messages:", error);
            });
        }

        // Function to update elapsed time
        function updateElapsedTime() {
          const currentTime = new Date();
          const elapsedTime = Math.floor((currentTime - startTime) / 1000); // elapsed time in seconds
          console.log("printing updateElapsedtime funtion");
          console.log(`Elapsed time: ${elapsedTime}s`);

          // Filter messages based on elapsedTime
          messages.forEach((message) => {
            if (elapsedTime === message.time_interval) {
              console.log(
                `Message for queue ${message.queue_name}: ${message.message_text}`
              );
              chatbotBody.innerHTML +=
                '<div class="chat-message"><p>' +
                message.message_text +
                "</p></div>";
              chatbotBody.scrollTop = chatbotBody.scrollHeight;
            }
          });
        }

        // Fetch messages initially
        fetchMessages().then(() => {
          console.log("printing inside fetchMessages calling one time");
          // Call updateElapsedTime every second
          intervalId = setInterval(updateElapsedTime, 1000);
        });
      }

      function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
          results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return "";
        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }

      function formatTimestamp() {
        const now = new Date();
        const formattedDate = now.toLocaleDateString("en-US", {
          month: "2-digit",
          day: "2-digit",
          year: "2-digit",
        });
        const formattedTime = now.toLocaleTimeString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });
        return `${formattedDate} ${formattedTime}`;
      }
    </script>
  </body>
</html> -->
